# ChÆ°Æ¡ng 2: Memory & Storage â€” Tá»« Flip-flop Ä‘áº¿n RAM

> **Má»¥c tiÃªu chÆ°Æ¡ng:** Hiá»ƒu cÃ¡ch transistor táº¡o ra bá»™ nhá»›, táº¡i sao cÃ³ nhiá»u táº§ng bá»™ nhá»› khÃ¡c nhau (Memory Hierarchy), vÃ  táº¡i sao **Cache Locality** lÃ  yáº¿u tá»‘ quyáº¿t Ä‘á»‹nh hiá»‡u nÄƒng trong Unity DOTS.

---

## 1. Váº¥n Ä‘á»: CPU nhanh, Bá»™ nhá»› cháº­m

HÃ£y tÆ°á»Ÿng tÆ°á»£ng báº¡n lÃ  má»™t Ä‘áº§u báº¿p thiÃªn tÃ i (CPU), cÃ³ thá»ƒ cháº¿ biáº¿n báº¥t ká»³ mÃ³n Äƒn nÃ o trong **1 giÃ¢y**. NhÆ°ng:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Äáº¦U Báº¾P (CPU) cáº§n nguyÃªn liá»‡u (Data):                             â”‚
â”‚                                                                      â”‚
â”‚  ğŸ“‹ Báº£ng ghi chÃº trÆ°á»›c máº·t (Registers):    Láº¥y ngay = 0 giÃ¢y       â”‚
â”‚  ğŸ§Š Tá»§ láº¡nh cáº¡nh báº¿p (L1 Cache):           Má»Ÿ láº¥y  = 2 giÃ¢y       â”‚
â”‚  ğŸ§Š Tá»§ láº¡nh ngoÃ i hÃ nh lang (L2 Cache):    Äi láº¥y  = 5 giÃ¢y       â”‚
â”‚  ğŸ§Š Kho láº¡nh táº§ng háº§m (L3 Cache):          Xuá»‘ng láº¥y = 15 giÃ¢y    â”‚
â”‚  ğŸª SiÃªu thá»‹ gáº§n nhÃ  (RAM):                Cháº¡y Ä‘i = 3 PHÃšT       â”‚
â”‚  ğŸšš NhÃ  kho ngoáº¡i thÃ nh (SSD):             Gá»i giao = 1 GIá»œ       â”‚
â”‚  ğŸš¢ Nháº­p kháº©u tá»« nÆ°á»›c ngoÃ i (HDD):         Äá»£i ship = 1 TUáº¦N      â”‚
â”‚                                                                      â”‚
â”‚  â†’ Äáº§u báº¿p (CPU) pháº£i Äá»¨NG Äá»¢I khi nguyÃªn liá»‡u á»Ÿ xa.              â”‚
â”‚    ÄÃ¢y gá»i lÃ  "Memory Stall" â€” CPU khÃ´ng lÃ m gÃ¬ cáº£, chá»‰ chá» data.  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Giáº£i phÃ¡p cá»§a ngÃ nh cÃ´ng nghiá»‡p:** Táº¡o ra nhiá»u táº§ng bá»™ nhá»› â€” nhá» nhÆ°ng nhanh á»Ÿ gáº§n CPU, lá»›n nhÆ°ng cháº­m á»Ÿ xa CPU. ÄÃ¢y lÃ  **Memory Hierarchy**.

---

## 2. Clock & Cycle â€” "Nhá»‹p tim" cá»§a CPU

> **ğŸ¯ áº¨n dá»¥ â€” Nháº¡c trÆ°á»Ÿng dÃ n nháº¡c:**
> TÆ°á»Ÿng tÆ°á»£ng dÃ n nháº¡c 100 ngÆ°á»i. Náº¿u ai cÅ©ng chÆ¡i lÃºc nÃ o tÃ¹y thÃ­ch â†’ **Há»–N LOáº N**.
> Nháº¡c trÆ°á»Ÿng giÆ¡ Ä‘Å©a â€” **"ÄÃNH!"** â€” táº¥t cáº£ 100 nháº¡c cÃ´ng cÃ¹ng Ä‘Ã¡nh ná»‘t tiáº¿p theo **Äá»’NG LOáº T**.
> Clock signal = **CÃ¢y Ä‘Å©a nháº¡c trÆ°á»Ÿng** cá»§a CPU.
> Má»—i láº§n "Ä‘Ã¡nh" = táº¥t cáº£ hÃ ng tá»· transistors trong CPU cáº­p nháº­t tráº¡ng thÃ¡i **CÃ™NG Má»˜T KHOáº¢NH KHáº®C**.

```
Clock lÃ  gÃ¬?

  Clock = Má»˜T TÃN HIá»†U ÄIá»†N cá»© láº·p Ä‘i láº·p láº¡i: CAO â†’ THáº¤P â†’ CAO â†’ THáº¤P...

  Äiá»‡n Ã¡p
  (Volts)
   1V â”€â”     â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”
       â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚
       â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚
   0V â”€â”˜â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€
                                                       
       â†‘           â†‘           â†‘           â†‘           â†‘
       â”‚           â”‚           â”‚           â”‚           â”‚
      TICK        TICK        TICK        TICK        TICK
    (Cáº¡nh lÃªn)  (Cáº¡nh lÃªn)  (Cáº¡nh lÃªn)  (Cáº¡nh lÃªn)  (Cáº¡nh lÃªn)

  Chá»‰ táº¡i má»—i Cáº NH LÃŠN (0V â†’ 1V), má»i thá»© xáº£y ra.
  Giá»¯a 2 cáº¡nh lÃªn = CPU Ä‘ang CHá»œ tÃ­n hiá»‡u á»•n Ä‘á»‹nh.
```

### 2.1. Cycle â€” 1 "nhá»‹p Ä‘áº­p" = 1 Ä‘Æ¡n vá»‹ thá»i gian

```
â•â•â• 1 Cycle = Khoáº£ng thá»i gian GIá»®A 2 cáº¡nh lÃªn liÃªn tiáº¿p â•â•â•

       â—„â”€â”€â”€â”€ 1 Cycle â”€â”€â”€â”€â–ºâ—„â”€â”€â”€â”€ 1 Cycle â”€â”€â”€â”€â–º
                                              
   1V â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€
       â”‚     â”‚             â”‚     â”‚             â”‚     â”‚
   0V â”€â”˜â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”˜

       â†‘                   â†‘                   â†‘
     Tick #1             Tick #2             Tick #3

  Trong 1 cycle, CPU lÃ m 1 "bÆ°á»›c" cÃ´ng viá»‡c. VÃ­ dá»¥:

  â”Œâ”€â”€â”€ Cycle 1 â”€â”€â”€â”â”Œâ”€â”€â”€ Cycle 2 â”€â”€â”€â”â”Œâ”€â”€â”€ Cycle 3 â”€â”€â”€â”
  â”‚  Táº£i lá»‡nh ADD â”‚â”‚ Giáº£i mÃ£ lá»‡nh  â”‚â”‚  Thá»±c thi ADD  â”‚
  â”‚  tá»« bá»™ nhá»›    â”‚â”‚ (cáº§n ALU nÃ o?) â”‚â”‚  trÃªn ALU      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘ TICK            â†‘ TICK            â†‘ TICK


â•â•â• Clock Speed = Bao nhiÃªu cycles Má»–I GIÃ‚Y? â•â•â•

  1 GHz  =  1,000,000,000 cycles/giÃ¢y    (1 cycle = 1.0 ns)
  3 GHz  =  3,000,000,000 cycles/giÃ¢y    (1 cycle = 0.33 ns)
  5 GHz  =  5,000,000,000 cycles/giÃ¢y    (1 cycle = 0.2 ns)
                                                     â†‘
                                          Ãnh sÃ¡ng Ä‘i Ä‘Æ°á»£c 6cm
                                          trong thá»i gian nÃ y!

  Nhá»‹p tim ngÆ°á»i:    ~1.2 Hz   (1.2 nhá»‹p/giÃ¢y)
  Nhá»‹p tim CPU:      ~5 GHz    (5 Tá»¶ nhá»‹p/giÃ¢y)
  â†’ CPU nhanh hÆ¡n tim báº¡n khoáº£ng 4,000,000,000 láº§n.
```

### 2.2. Táº¡i sao cáº§n Clock? â€” Chaos vs Order

```
  â•â•â• KHÃ”NG CÃ“ CLOCK â•â•â•

  Transistor A xong â†’ gá»­i káº¿t quáº£ cho B
  NhÆ°ng B chÆ°a sáºµn sÃ ng! â†’ Káº¿t quáº£ bá»‹ Máº¤T hoáº·c SAI
  Transistor C xong trÆ°á»›c A? â†’ Thá»© tá»± loáº¡n, káº¿t quáº£ vÃ´ nghÄ©a

  = 100 nháº¡c cÃ´ng chÆ¡i tÃ¹y há»©ng â†’ CACophony ğŸ”‡


  â•â•â• CÃ“ CLOCK â•â•â•

  TICK â†’ Táº¤T Cáº¢ flip-flops "chá»¥p áº£nh" dá»¯ liá»‡u CÃ™NG LÃšC
       â†’ Káº¿t quáº£ á»•n Ä‘á»‹nh, Ä‘Ãºng thá»© tá»±
       â†’ BÆ°á»›c tiáº¿p theo chá»‰ báº¯t Ä‘áº§u khi bÆ°á»›c trÆ°á»›c Ä‘Ã£ xong

  = 100 nháº¡c cÃ´ng cÃ¹ng nhÃ¬n nháº¡c trÆ°á»Ÿng â†’ Symphony ğŸµ


  CPU 5 GHz = Nháº¡c trÆ°á»Ÿng Ä‘Ã¡nh 5 Tá»¶ nhá»‹p má»—i giÃ¢y.
  Má»—i nhá»‹p = hÃ ng tá»· transistors cÃ¹ng bÆ°á»›c sang tráº¡ng thÃ¡i má»›i.
  â†’ ÄÃ¢y lÃ  lÃ½ do "overclock" (tÄƒng GHz) nguy hiá»ƒm:
     Náº¿u nháº¡c trÆ°á»Ÿng Ä‘Ã¡nh quÃ¡ nhanh, nháº¡c cÃ´ng chÆ°a ká»‹p Ä‘Ã¡nh ná»‘t
     trÆ°á»›c Ä‘Ã³ â†’ SAI Ná»T â†’ CPU crash / BSOD / artifact rendering.
```

---

## 3. Flip-flop â€” ViÃªn gáº¡ch Ä‘áº§u tiÃªn cá»§a Bá»™ nhá»›

### BÃ i toÃ¡n: LÃ m sao "nhá»›" 1 bit?

á» Chapter 1, ta biáº¿t cá»•ng logic cho output **tá»©c thÃ¬** dá»±a trÃªn input hiá»‡n táº¡i. NhÆ°ng nÃ³ **khÃ´ng nhá»›** gÃ¬ cáº£ â€” thay Ä‘á»•i input thÃ¬ output Ä‘á»•i ngay.

**Flip-flop** giáº£i quyáº¿t váº¥n Ä‘á» nÃ y báº±ng 1 trick Ä‘Æ¡n giáº£n: **ná»‘i output ngÆ°á»£c láº¡i input** (feedback loop).

> **ğŸ¯ áº¨n dá»¥ â€” CÃ´ng táº¯c Ä‘Ã¨n:**
> - Báº¡n **báº­t** Ä‘Ã¨n (Set) â†’ Ä‘Ã¨n sÃ¡ng. Bá» tay ra â€” Ä‘Ã¨n **VáºªN SÃNG**.
> - Báº¡n **táº¯t** Ä‘Ã¨n (Reset) â†’ Ä‘Ã¨n táº¯t. Bá» tay ra â€” Ä‘Ã¨n **VáºªN Táº®T**.
> - ÄÃ¨n "nhá»›" tráº¡ng thÃ¡i cuá»‘i cÃ¹ng mÃ  khÃ´ng cáº§n báº¡n giá»¯ tay.
> - ÄÃ³ chÃ­nh lÃ  **feedback loop**: tráº¡ng thÃ¡i tá»± duy trÃ¬ chÃ­nh nÃ³.

**Chá»‰ cáº§n nhá»› 3 Ä‘iá»u vá» Flip-flop:**

| # | Äiá»u cáº§n nhá»› | Chi tiáº¿t |
|---|---|---|
| 1 | **Nhá»› Ä‘Ãºng 1 bit** (0 hoáº·c 1) | ÄÆ°á»£c xÃ¢y tá»« ~2 cá»•ng logic + feedback loop |
| 2 | **Chá»‰ thay Ä‘á»•i khi Clock "tick"** | Giá»‘ng mÃ¡y áº£nh: chá»‰ "chá»¥p" dá»¯ liá»‡u táº¡i Ä‘Ãºng nhá»‹p Clock â†‘ |
| 3 | **LÃ  ná»n táº£ng cá»§a Má»ŒI bá»™ nhá»›** | Register, Cache, RAM â€” táº¥t cáº£ Ä‘á»u báº¯t nguá»“n tá»« nguyÃªn lÃ½ nÃ y |

> Chá»‰ tá»« ~8 transistors, ta táº¡o ra thá»© cÃ³ thá»ƒ **NHá»š**. Má»i bá»™ nhá»› trÃªn tháº¿ giá»›i â€” tá»« Register trong CPU Ä‘áº¿n thanh RAM 64GB â€” Ä‘á»u báº¯t nguá»“n tá»« nguyÃªn lÃ½ feedback loop nÃ y.

---

## 3. Tá»« Flip-flop â†’ Register â†’ Register File

### 3.1. Register â€” 32 Flip-flops = 1 tá»« dá»¯ liá»‡u

```
32-bit Register (vÃ­ dá»¥: Register EAX trong x86):

  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€ ... â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
  â”‚ D-FF â”‚ D-FF â”‚ D-FF â”‚ D-FF â”‚           â”‚ D-FF â”‚ D-FF â”‚
  â”‚ #31  â”‚ #30  â”‚ #29  â”‚ #28  â”‚           â”‚  #1  â”‚  #0  â”‚
  â””â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€ ... â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”˜
     â”‚      â”‚      â”‚      â”‚                   â”‚      â”‚
     Q31    Q30    Q29    Q28              Q1     Q0

  CLK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (Táº¥t cáº£ 32 flip-flops nháº­n CÃ™NG tÃ­n hiá»‡u Clock)

  Khi CLK â†‘: Cáº£ 32 bit Ä‘Æ°á»£c ghi Äá»’NG THá»œI
  â†’ Ghi má»™t sá»‘ int 32-bit chá»‰ máº¥t 1 clock cycle

#### > Code to Hardware: MOV
1.  **C#:** `int x = 42;`
2.  **Assembly:** `MOV EAX, 42`
3.  **Hardware:**
    *   `42` (nhá»‹ phÃ¢n `101010`) Ä‘Æ°á»£c Ä‘Æ°a vÃ o Ä‘áº§u vÃ o D cá»§a cÃ¡c Flip-flop tÆ°Æ¡ng á»©ng trong Register EAX.
    *   TÃ­n hiá»‡u `Write Enable` cho EAX Ä‘Æ°á»£c báº­t.
    *   Táº¡i cáº¡nh lÃªn Clock tiáº¿p theo: EAX chá»‘t giÃ¡ trá»‹ 42.

#### > Register vs RAM:
*   `MOV EAX, EBX` (Register to Register): **0.2 ns** (ngay láº­p tá»©c).
*   `MOV EAX, [EBX]` (RAM to Register): **100 ns** (pháº£i Ä‘á»£i tÃ­n hiá»‡u Ä‘i ra mainboard vÃ  quay láº¡i!).


VÃ­ dá»¥ cá»¥ thá»ƒ:
  Sá»‘ nguyÃªn 42 = 00000000 00000000 00000000 00101010
  â†’ 32 flip-flops lÆ°u:
     FF#31=0, FF#30=0, ... FF#5=1, FF#4=0, FF#3=1, FF#2=0, FF#1=1, FF#0=0
```

> **ğŸ¯ áº¨n dá»¥ â€” BÃ n tay cá»§a Äáº§u báº¿p:**
> Register = **MÃ“N Äá»’ ÄANG Cáº¦M TRÃŠN TAY** Ä‘áº§u báº¿p.
> - Äáº§u báº¿p (CPU) chá»‰ cÃ³ 2 tay (Ã­t registers).
> - CÃ¡i gÃ¬ trÃªn tay â†’ dÃ¹ng Ä‘Æ°á»£c NGAY Láº¬P Tá»¨C (0 delay).
> - NhÆ°ng chá»‰ cáº§m Ä‘Æ°á»£c 2-3 thá»© cÃ¹ng lÃºc â†’ pháº£i bá» xuá»‘ng bÃ n (Cache) hoáº·c cáº¥t vÃ o tá»§ (RAM) náº¿u muá»‘n láº¥y thá»© khÃ¡c.
> - Tá»‘c Ä‘á»™: Cáº§m trÃªn tay > Láº¥y tá»« bÃ n > Äi bá»™ tá»›i tá»§ > Cháº¡y ra kho ngoÃ i sÃ¢n.

### 3.2. Register File â€” Bá»™ nhá»› "ngay tay" cá»§a CPU

**Register File náº±m á»Ÿ Ä‘Ã¢u trong CPU?**

```
â•â•â• BÃªn trong 1 CPU Core (Máº·t cáº¯t Ä‘Æ¡n giáº£n hÃ³a) â•â•â•

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                         CPU CORE #0                              â”‚
  â”‚                                                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â˜… CU â€” CONTROL UNIT (Bá»™ Ä‘iá»u khiá»ƒn = "Báº¿p trÆ°á»Ÿng")      â”‚  â”‚
  â”‚  â”‚                                                            â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
  â”‚  â”‚  â”‚ Fetch     â”‚â”€â–ºâ”‚ Decoder   â”‚â”€â–ºâ”‚ Scheduler / Rename  â”‚   â”‚  â”‚
  â”‚  â”‚  â”‚ (Táº£i lá»‡nh â”‚  â”‚ (Giáº£i mÃ£  â”‚  â”‚ (PhÃ¢n cÃ´ng lá»‡nh     â”‚   â”‚  â”‚
  â”‚  â”‚  â”‚  tá»« L1i)  â”‚  â”‚  â†’ Î¼ops)  â”‚  â”‚  cho ALU/FPU/MU)    â”‚   â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
  â”‚  â”‚                                            â”‚              â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚              â”‚  â”‚
  â”‚  â”‚  â”‚ Branch Predictorâ”‚  (ÄoÃ¡n nhÃ¡nh if/else) â”‚              â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚              â”‚  â”‚
  â”‚  â”‚                                            â”‚              â”‚  â”‚
  â”‚  â”‚  CU KHÃ”NG tÃ­nh toÃ¡n. NÃ³ chá»‰ ra lá»‡nh:      â”‚              â”‚  â”‚
  â”‚  â”‚  "Gá»­i EAX vÃ o ALU", "Báº£o MU Ä‘i láº¥y data"  â”‚              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                               â”‚                  â”‚
  â”‚                                               â–¼                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â˜…â˜…â˜… REGISTER FILE â˜…â˜…â˜…  (TRUNG TÃ‚M â€” "Máº·t bÃ n báº¿p")     â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”      â”‚  â”‚
  â”‚  â”‚  â”‚ RAX â”‚ RBX â”‚ RCX â”‚ RDX â”‚ RSP â”‚ RBP â”‚ RSI â”‚ RDI â”‚      â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤      â”‚  â”‚
  â”‚  â”‚  â”‚ R8  â”‚ R9  â”‚ R10 â”‚ R11 â”‚ R12 â”‚ R13 â”‚ R14 â”‚ R15 â”‚      â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤      â”‚  â”‚
  â”‚  â”‚  â”‚XMM0 â”‚XMM1 â”‚XMM2 â”‚...  â”‚XMM14â”‚XMM15â”‚FLAGSâ”‚ RIP â”‚      â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”¬â”€â”€â”´â”€â”€â”¬â”€â”€â”´â”€â”€â”¬â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚        â”‚     â”‚     â”‚                                            â”‚
  â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚   â”‚  ALU / FPU  (Execution Units â€” "Äáº§u báº¿p tÃ­nh toÃ¡n")     â”‚  â”‚
  â”‚   â”‚                                                          â”‚  â”‚
  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
  â”‚   â”‚  â”‚ ALU 0 â”‚  â”‚ ALU 1 â”‚  â”‚ FPU 0 â”‚  â”‚ FPU 1 â”‚            â”‚  â”‚
  â”‚   â”‚  â”‚(+, -, â”‚  â”‚(Ã—, Ã·, â”‚  â”‚(float â”‚  â”‚(float â”‚            â”‚  â”‚
  â”‚   â”‚  â”‚ logic)â”‚  â”‚ shift) â”‚  â”‚ add)  â”‚  â”‚ mul)  â”‚            â”‚  â”‚
  â”‚   â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜            â”‚  â”‚
  â”‚   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
  â”‚   â”‚                    â”‚                                      â”‚  â”‚
  â”‚   â”‚                    â–¼  Káº¿t quáº£ GHI NGÆ¯á»¢C láº¡i Register     â”‚  â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                                  â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚   â”‚  â˜… MU â€” MEMORY UNIT (Bá»™ truy xuáº¥t bá»™ nhá»› = "NV Kho")   â”‚  â”‚
  â”‚   â”‚                                                          â”‚  â”‚
  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
  â”‚   â”‚  â”‚ Load Unit â”‚  â”‚Store Unit â”‚  â”‚  TLB              â”‚   â”‚  â”‚
  â”‚   â”‚  â”‚ (Äá»c data â”‚  â”‚(Ghi data  â”‚  â”‚ (Cache Ä‘á»‹a chá»‰   â”‚   â”‚  â”‚
  â”‚   â”‚  â”‚  vÃ o Reg) â”‚  â”‚ ra ngoÃ i) â”‚  â”‚  áº£o â†’ váº­t lÃ½)     â”‚   â”‚  â”‚
  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
  â”‚   â”‚        â”‚              â”‚                                  â”‚  â”‚
  â”‚   â”‚        â–¼              â–¼                                  â”‚  â”‚
  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚  â”‚
  â”‚   â”‚  â”‚ L1d Cache (32-64 KB)    â”‚  â† SRAM, gáº§n nháº¥t         â”‚  â”‚
  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚  â”‚
  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚  â”‚
  â”‚   â”‚  â”‚ L2 Cache (256KB-1MB)    â”‚  â† Xa hÆ¡n, cháº­m hÆ¡n 3Ã—   â”‚  â”‚
  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚  â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚  (Bus ra ngoÃ i chip CPU)
        â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  L3 Cache (Shared)       â”‚  â† Chia sáº» giá»¯a cÃ¡c cores (8-96 MB)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼  (Ra khá»i chip â†’ qua mainboard)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  DDR5 RAM (DRAM)         â”‚  â† Chip riÃªng, xa nháº¥t
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| ThÃ nh pháº§n | Vai trÃ² | áº¨n dá»¥ nhÃ  báº¿p |
|---|---|---|
| **CU** | Äá»c lá»‡nh, giáº£i mÃ£, phÃ¢n cÃ´ng | ğŸ‘¨â€ğŸ³ Báº¿p trÆ°á»Ÿng |
| **Register File** | LÆ°u data Ä‘ang dÃ¹ng NGAY | ğŸ½ï¸ Máº·t bÃ n báº¿p |
| **ALU/FPU** | TÃ­nh toÃ¡n (+, -, Ã—, float) | ğŸ”ª Äáº§u báº¿p |
| **MU** | Láº¥y/cáº¥t data tá»« Cache/RAM | ğŸ“¦ NhÃ¢n viÃªn kho |
| **L1 Cache** | Kho nhá» ngay cáº¡nh báº¿p | ğŸ§Š Tá»§ láº¡nh báº¿p |
| **L2 Cache** | Kho dá»± trá»¯ trong nhÃ  | ğŸ  Kho phá»¥ |
| **L3 Cache** | Kho chung cho táº¥t cáº£ báº¿p | ğŸ—ï¸ Kho táº§ng háº§m |
| **DDR5 RAM** | Kho hÃ ng ngoáº¡i vi | ğŸª SiÃªu thá»‹ |

**DÃ²ng cháº£y lá»‡nh `MOV EAX, [address]`:**

1. **CU** Ä‘á»c lá»‡nh â†’ "Ã€, cáº§n load data tá»« bá»™ nhá»›"
2. **CU** giao cho **MU** (Load Unit) â†’ "Äi láº¥y data á»Ÿ Ä‘á»‹a chá»‰ nÃ y!"
3. **MU** kiá»ƒm tra L1 Cache:
   - **HIT?** â†’ Tráº£ data ngay (3-4 cycles)
   - **MISS?** â†’ Há»i L2 (10 cycles) â†’ L3 (30 cycles) â†’ RAM (200 cycles)
4. **MU** nháº­n data â†’ Ghi vÃ o **Register File** (EAX)
5. **CU** tiáº¿p tá»¥c lá»‡nh tiáº¿p theo (vÃ­ dá»¥: `ADD EAX, 5` â†’ gá»­i EAX tá»›i ALU)

> **Äiá»ƒm máº¥u chá»‘t:** Register File náº±m **NGAY TRUNG TÃ‚M** CPU Core, cÃ¡ch ALU chá»‰ vÃ i **micromet** (1 micromet = 1/1000 mm). TÃ­n hiá»‡u Ä‘iá»‡n Ä‘i tá»« Register â†’ ALU â†’ Register trong **cÃ¹ng 1 clock cycle**. ÄÃ¢y lÃ  lÃ½ do nÃ³ nhanh nháº¥t.

**DÃ²ng cháº£y dá»¯ liá»‡u trong 1 phÃ©p tÃ­nh:**

```
VÃ­ dá»¥: ADD EAX, EBX  (EAX = EAX + EBX)

  Cycle 1:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ REGISTER FILEâ”‚
  â”‚              â”‚
  â”‚  EAX â”€â”€ 42 â”€â”¼â”€â”€â”€â”€ Port A â”€â”€â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”
  â”‚              â”‚                 â”‚       â”‚
  â”‚  EBX â”€â”€ 10 â”€â”¼â”€â”€â”€â”€ Port B â”€â”€â”€â”€â–ºâ”‚  ALU  â”‚â”€â”€â”€â”€ Result: 52
  â”‚              â”‚                 â”‚       â”‚
  â”‚              â”‚â—„â”€â”€ Write Port â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚  EAX â”€â”€ 52  â”‚   (Ghi káº¿t quáº£ láº¡i vÃ o EAX)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Táº¥t cáº£ xáº£y ra trong 1 CYCLE duy nháº¥t:
  1. Äá»c EAX (42) qua Port A         } CÃ¹ng
  2. Äá»c EBX (10) qua Port B         } lÃºc!
  3. ALU tÃ­nh 42 + 10 = 52            }
  4. Ghi 52 láº¡i vÃ o EAX qua Write Port}

  â†’ Register File cÃ³ NHIá»€U cá»•ng (ports) Ä‘á»ƒ Ä‘á»c/ghi Äá»’NG THá»œI.
  â†’ ÄÃ¢y lÃ  Multi-ported Register File = 2 Read + 1 Write cÃ¹ng lÃºc.
  â†’ So sÃ¡nh: RAM chá»‰ cÃ³ 1 cá»•ng, pháº£i Ä‘á»c rá»“i má»›i ghi â†’ cháº­m hÆ¡n.
```

**Registers "tháº­t" vs Registers "áº£o" â€” Register Renaming:**

```
Báº¡n NHÃŒN THáº¤Y 16 registers (RAX, RBX, ..., R15) trong Assembly.
NhÆ°ng CPU THáº¬T Sá»° cÃ³ ~180-200 registers váº­t lÃ½ bÃªn trong!

Táº¡i sao? Äá»ƒ cháº¡y Out-of-Order (xÃ¡o trá»™n thá»© tá»± lá»‡nh):

  VÃ­ dá»¥ 2 lá»‡nh Äá»˜C Láº¬P nhÆ°ng dÃ¹ng CÃ™NG thanh ghi:
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Lá»‡nh 1:  ADD  EAX, 5       ; EAX = EAX + 5
  Lá»‡nh 2:  MOV  EAX, [mem]   ; EAX = giÃ¡ trá»‹ tá»« RAM â† CÃ™NG EAX!

  Váº¥n Ä‘á»: Lá»‡nh 2 GHI ÄÃˆ lÃªn EAX, nhÆ°ng lá»‡nh 1 cÅ©ng cáº§n EAX.
  â†’ CPU khÃ´ng thá»ƒ cháº¡y song song!

  Giáº£i phÃ¡p â€” Register Renaming:
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CPU Ä‘á»•i tÃªn bÃªn trong:
  Lá»‡nh 1:  ADD  P47, 5       ; EAX â†’ mapped sang Physical Register #47
  Lá»‡nh 2:  MOV  P92, [mem]   ; EAX â†’ mapped sang Physical Register #92

  â†’ BÃ¢y giá» 2 lá»‡nh KHÃ”NG Äá»¤NG NHAU â†’ cháº¡y song song Ä‘Æ°á»£c!
  â†’ Programmer váº«n tháº¥y "EAX" â€” nhÆ°ng bÃªn trong lÃ  registers khÃ¡c nhau.

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Architectural Registers     Physical Registers              â”‚
  â”‚  (Báº¡n tháº¥y trong Assembly)   (CPU tháº­t sá»± dÃ¹ng bÃªn trong)  â”‚
  â”‚                                                              â”‚
  â”‚  EAX  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  P47, P92, P15, ...               â”‚
  â”‚  EBX  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  P03, P88, ...                    â”‚
  â”‚  ECX  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  P55, P12, ...                    â”‚
  â”‚  ...                       (Pool ~180-200 registers)        â”‚
  â”‚                                                              â”‚
  â”‚  16 tÃªn â† mapping â†’ ~200 registers váº­t lÃ½                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
Register File trong CPU x86-64 (Ä‘Æ¡n giáº£n hÃ³a):

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   REGISTER FILE                         â”‚
  â”‚                                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  RAX   â”‚ 0000 0000 0000 0000 0000 0000 0010 1010 â”‚  â”‚  â† 64-bit
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  RBX   â”‚ 0000 0000 0000 0000 0000 0000 0000 0011 â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  RCX   â”‚ 0000 0000 0000 0000 0000 0000 0000 1010 â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  RDX   â”‚ 0000 0000 0000 0000 0000 0000 0000 0101 â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  RSP   â”‚ â† Stack Pointer (Ä‘á»‰nh Stack)            â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  RBP   â”‚ â† Base Pointer (Ä‘Ã¡y Stack Frame)        â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  RIP   â”‚ â† Instruction Pointer (lá»‡nh tiáº¿p theo)  â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  ...   â”‚ (tá»•ng ~16 registers general-purpose)     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                         â”‚
  â”‚  SIMD Registers (cho Burst Compiler):                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ XMM0   â”‚ 128-bit (4 Ã— float32)                   â”‚  â”‚  â† SSE
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ YMM0   â”‚ 256-bit (8 Ã— float32)                   â”‚  â”‚  â† AVX
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ ZMM0   â”‚ 512-bit (16 Ã— float32)                  â”‚  â”‚  â† AVX-512
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚  ...   â”‚ (XMM0-XMM15 / YMM0-YMM15)              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                         â”‚
  â”‚  Tá»•ng dung lÆ°á»£ng Register File: ~1-2 KB                 â”‚
  â”‚  Tá»‘c Ä‘á»™ truy cáº­p: 0 cycles (tá»©c thÃ¬, cÃ¹ng clock)       â”‚
  â”‚  Transistor cost: ~VÃ i nghÃ¬n transistor (ráº»)            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **Unity DOTS Connection:** Khi Burst Compiler biÃªn dá»‹ch `float3 a + float3 b`, nÃ³ Ä‘áº·t `a` vÃ o XMM0 vÃ  `b` vÃ o XMM1, rá»“i gá»i lá»‡nh `ADDPS` â€” cá»™ng cáº£ 3 thÃ nh pháº§n (x,y,z) **cÃ¹ng 1 lá»‡nh** trÃªn thanh ghi 128-bit. ÄÃ³ lÃ  sá»©c máº¡nh SIMD.

---

## 4. SRAM vs DRAM â€” Hai cÃ¡ch xÃ¢y bá»™ nhá»› tá»« Transistor

### 4.1. SRAM (Static RAM) â€” DÃ¹ng cho Cache

```
SRAM Cell â€” 1 bit = 6 Transistors:

        Vdd                Vdd
         â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚  PMOS   â”‚        â”‚  PMOS   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
         â”œâ”€â”€â”€â”€â”¤Inverterâ”œâ”€â”€â”€â”€â”¤
         â”‚    â”‚  Loop  â”‚    â”‚        â† VÃ²ng feedback (2 inverters)
         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚           Giá»¯ nguyÃªn tráº¡ng thÃ¡i
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”     mÃ  KHÃ”NG cáº§n lÃ m má»›i
    â”‚  NMOS   â”‚        â”‚  NMOS   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                  â”‚
        GND                GND

  + 2 NMOS transistor lÃ m "cá»•ng truy cáº­p" (Access Transistors)
  = Tá»•ng 6 Transistors / bit

Äáº·c Ä‘iá»ƒm SRAM:
  âœ… Cá»±c nhanh (~1ns)
  âœ… KhÃ´ng cáº§n refresh (giá»¯ data náº¿u cÃ³ Ä‘iá»‡n)
  âŒ Äáº¯t (6 transistors/bit)
  âŒ Tá»‘n diá»‡n tÃ­ch (lá»›n gáº¥p 6Ã— DRAM)
  â†’ DÃ¹ng cho: L1, L2, L3 Cache
```

### 4.2. DRAM (Dynamic RAM) â€” DÃ¹ng cho RAM chÃ­nh

```
DRAM Cell â€” 1 bit = 1 Transistor + 1 Tá»¥ Ä‘iá»‡n:

    Word Line (HÃ ng)
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚  NMOS   â”‚â”€â”€â”€â”€ Bit Line (Cá»™t)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚  Tá»¥     â”‚     â† Tá»¥ Ä‘iá»‡n (Capacitor) LÆ¯U ÄIá»†N TÃCH
    â”‚ Ä‘iá»‡n    â”‚        CÃ³ Ä‘iá»‡n = 1, KhÃ´ng Ä‘iá»‡n = 0
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
        GND

Äáº·c Ä‘iá»ƒm DRAM:
  âœ… Ráº» (1 transistor + 1 tá»¥ / bit)
  âœ… Máº­t Ä‘á»™ cao (nhiá»u GB trong chip nhá»)
  âŒ Cháº­m hÆ¡n SRAM (~50-100ns)
  âŒ Pháº£i REFRESH liÃªn tá»¥c (tá»¥ Ä‘iá»‡n rÃ² rá»‰ charge)
     â†’ Cá»© ~64ms pháº£i Ä‘á»c láº¡i vÃ  ghi láº¡i Táº¤T Cáº¢ cells
     â†’ Trong lÃºc refresh, RAM KHÃ”NG THá»‚ Ä‘á»c/ghi â†’ thÃªm trá»…
  â†’ DÃ¹ng cho: RAM chÃ­nh (DDR4, DDR5)
```

### 4.3. So sÃ¡nh trá»±c quan

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          SRAM vs DRAM â€” CÃ¹ng lÆ°u 1 bit, khÃ¡c hoÃ n toÃ n           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               â”‚     SRAM         â”‚         DRAM                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Transistor    â”‚ 6 / bit          â”‚ 1 / bit + 1 tá»¥ Ä‘iá»‡n           â”‚
â”‚ Tá»‘c Ä‘á»™       â”‚ ~1 ns            â”‚ ~50-100 ns                    â”‚
â”‚ Chi phÃ­       â”‚ $$$$             â”‚ $                              â”‚
â”‚ Cáº§n Refresh?  â”‚ KhÃ´ng            â”‚ CÃ³ (má»—i ~64ms)               â”‚
â”‚ Dung lÆ°á»£ng    â”‚ MB (nhá»)         â”‚ GB (lá»›n)                     â”‚
â”‚ Vá»‹ trÃ­       â”‚ TrÃªn chip CPU    â”‚ Chip riÃªng trÃªn mainboard      â”‚
â”‚ Vai trÃ²      â”‚ L1/L2/L3 Cache   â”‚ RAM chÃ­nh (DDR5)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  áº¨n dá»¥:                                                           â”‚
â”‚  SRAM = NgÄƒn kÃ©o bÃ n lÃ m viá»‡c (nhá», láº¥y ngay, Ä‘áº¯t)              â”‚
â”‚  DRAM = Tá»§ há»“ sÆ¡ á»Ÿ gÃ³c phÃ²ng (lá»›n, pháº£i Ä‘á»©ng dáº­y Ä‘i láº¥y, ráº»)   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4. Bá»©c tranh toÃ n cáº£nh â€” Flip-flop vs Register vs SRAM vs DRAM

> **ğŸ¯ áº¨n dá»¥ thá»‘ng nháº¥t â€” "BÃ n há»c cá»§a Sinh viÃªn":**
>
> HÃ£y tÆ°á»Ÿng tÆ°á»£ng báº¡n Ä‘ang **Ã´n thi** trong kÃ½ tÃºc xÃ¡:
>
> | Loáº¡i bá»™ nhá»› | áº¨n dá»¥ | VÃ­ dá»¥ thá»±c táº¿ |
> |---|---|---|
> | **1 Flip-flop** | **1 Ã´ Post-it** â€” dÃ¡n 1 chá»¯ sá»‘ (0 hoáº·c 1) | Nhá»› Ä‘Ãºng 1 bit |
> | **1 Register** | **1 dÃ²ng Post-it** â€” 32 Ã´ dÃ¡n liá»n nhau = 1 con sá»‘ | Nhá»› 1 sá»‘ int (VD: `42`) |
> | **SRAM (Cache)** | **Máº·t bÃ n há»c** â€” vÃ i tá» giáº¥y Ä‘ang má»Ÿ, Ä‘á»c ngay | L1/L2/L3 Cache trÃªn CPU |
> | **DRAM (RAM)** | **Ká»‡ sÃ¡ch trong phÃ²ng** â€” pháº£i Ä‘á»©ng dáº­y Ä‘i láº¥y | DDR5 RAM 16-64 GB |
> | *(SSD/HDD)* | **ThÆ° viá»‡n downstairs** â€” pháº£i Ä‘i thang mÃ¡y | á»” cá»©ng lÆ°u trá»¯ |
>
> **Äiá»ƒm máº¥u chá»‘t:**
> - Flip-flop â†’ Register â†’ SRAM â†’ DRAM **khÃ´ng pháº£i** 4 thá»© khÃ¡c nhau.
> - ChÃºng lÃ  **CÃ™NG 1 Ã½ TÆ¯á»NG** ("nhá»› bit") nhÆ°ng Ä‘Æ°á»£c **xÃ¢y khÃ¡c nhau** Ä‘á»ƒ Ä‘Ã¡nh Ä‘á»•i giá»¯a **tá»‘c Ä‘á»™** vÃ  **dung lÆ°á»£ng**.

```
CÃ¡ch xÃ¢y tá»« nhá» â†’ lá»›n:

  1 Flip-flop = 1 bit nhá»›
       â”‚
       â”‚ Ã— 32 cÃ¡i ghÃ©p láº¡i
       â–¼
  1 Register = 32 bits = 1 con sá»‘
       â”‚
       â”‚  QuÃ¡ Ä‘áº¯t Ä‘á»ƒ lÃ m nhiá»u â†’ dÃ¹ng máº¡ch SRAM Ä‘Æ¡n giáº£n hÆ¡n
       â–¼
  SRAM = Bá» bá»›t máº¡ch (6 transistor/bit thay vÃ¬ ~20)
       â”‚  â†’ Cháº­m hÆ¡n Register nhÆ°ng chá»©a Ä‘Æ°á»£c MB
       â”‚
       â”‚  Váº«n quÃ¡ Ä‘áº¯t â†’ thay transistor báº±ng tá»¥ Ä‘iá»‡n
       â–¼
  DRAM = 1 transistor + 1 tá»¥ Ä‘iá»‡n / bit
         â†’ Cháº­m hÆ¡n SRAM nhÆ°ng chá»©a Ä‘Æ°á»£c GB
         â†’ Pháº£i refresh (tá»¥ rÃ² rá»‰) â†’ thÃªm cháº­m


  Tá»‘c Ä‘á»™:    Register >>>>>>> SRAM >>>>>> DRAM
  Dung lÆ°á»£ng: Register <<<<<<< SRAM <<<<<< DRAM  
  GiÃ¡ tiá»n:   Register $$$$$$$ SRAM $$$$$$ DRAM $
```

---

## 5. Cache â€” Bá»™ Ä‘á»‡m thay Ä‘á»•i cuá»™c chÆ¡i

### 5.1. Táº¡i sao cáº§n Cache?

```
Tá»‘c Ä‘á»™ qua cÃ¡c tháº¿ há»‡ (1980 â†’ nay):

  CPU Speed:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Ã—10,000 láº§n
  RAM Speed:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                 Ã—100 láº§n

  â†’ "Memory Wall": CPU pháº£i CHá»œ RAM hÃ ng trÄƒm chu ká»³.
     Má»—i chu ká»³ chá» = lÃ£ng phÃ­ hÃ ng tá»· phÃ©p tÃ­nh/giÃ¢y.


Giáº£i phÃ¡p = Cache (Bá»™ Ä‘á»‡m SRAM náº±m trÃªn chip CPU):

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  CPU Die (Máº·t cáº¯t chip tháº­t)    â”‚
  â”‚                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”             â”‚
  â”‚  â”‚Core 0â”‚  â”‚Core 1â”‚             â”‚
  â”‚  â”‚â”Œâ”€L1â”€â”â”‚  â”‚â”Œâ”€L1â”€â”â”‚             â”‚
  â”‚  â”‚â””â”€â”€â”€â”€â”˜â”‚  â”‚â””â”€â”€â”€â”€â”˜â”‚             â”‚
  â”‚  â”‚â”Œâ”€L2â”€â”â”‚  â”‚â”Œâ”€L2â”€â”â”‚             â”‚
  â”‚  â”‚â””â”€â”€â”€â”€â”˜â”‚  â”‚â””â”€â”€â”€â”€â”˜â”‚             â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜             â”‚
  â”‚                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚     L3 Cache (Shared)    â”‚    â”‚    â† SRAM chiáº¿m >50% diá»‡n tÃ­ch chip!
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚  (ÄÆ°á»ng bus ra ngoÃ i chip)
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  DDR5 RAM (DRAM) â”‚   â† Chip riÃªng biá»‡t trÃªn mainboard
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2. Cache Line â€” ÄÆ¡n vá»‹ truyá»n dá»¯ liá»‡u cÆ¡ báº£n

**ÄÃ¢y lÃ  khÃ¡i niá»‡m QUAN TRá»ŒNG NHáº¤T cho hiá»‡u nÄƒng Unity DOTS.**

```
CPU KHÃ”NG BAO GIá»œ Ä‘á»c 1 byte Ä‘Æ¡n láº» tá»« RAM.
NÃ³ luÃ´n Ä‘á»c 1 CACHE LINE = 64 BYTES.

VÃ­ dá»¥: Báº¡n truy cáº­p array[0] (4 bytes int):

  RAM:
  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
  â”‚ [0]â”‚ [1]â”‚ [2]â”‚ [3]â”‚ [4]â”‚ [5]â”‚ [6]â”‚ [7]â”‚ [8]â”‚ [9]â”‚[10]â”‚[11]â”‚[12]â”‚[13]â”‚[14]â”‚[15]â”‚
  â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚ 4B â”‚
  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 64 bytes (1 Cache Line) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º

  Báº¡n chá»‰ cáº§n [0], nhÆ°ng CPU táº£i TOÃ€N Bá»˜ 64 bytes vÃ o L1 Cache.
  â†’ [1] Ä‘áº¿n [15] Ä‘Ã£ cÃ³ sáºµn trong Cache â†’ truy cáº­p miá»…n phÃ­!


Há»‡ quáº£:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Náº¾U báº¡n duyá»‡t array TUáº¦N Tá»° ([0], [1], [2], ...):        â”‚
  â”‚    â†’ Cache Hit gáº§n 100% (chá»‰ 1 láº§n táº£i / 16 pháº§n tá»­)      â”‚
  â”‚    â†’ Cá»°C NHANH                                              â”‚
  â”‚                                                              â”‚
  â”‚  Náº¾U báº¡n duyá»‡t array NGáºªU NHIÃŠN ([7], [1023], [3], ...):  â”‚
  â”‚    â†’ Cache Miss liÃªn tá»¥c (má»—i truy cáº­p = táº£i cache line má»›i)â”‚
  â”‚    â†’ Cá»°C CHáº¬M (100-300Ã— cháº­m hÆ¡n!)                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **ğŸ¯ áº¨n dá»¥ â€” Kho hÃ ng Amazon:**
> Cache Line = **ThÃ¹ng hÃ ng Ä‘Ã³ng gÃ³i sáºµn** trong kho Amazon.
> - Báº¡n Ä‘áº·t mua **1 cuá»‘n sÃ¡ch** (4 bytes). Amazon khÃ´ng gá»­i riÃªng 1 cuá»‘n.
> - Há» gá»­i **cáº£ thÃ¹ng 16 cuá»‘n** cÃ¹ng chá»§ Ä‘á» (64 bytes = 1 Cache Line).
> - Náº¿u báº¡n Ä‘á»c háº¿t bá»™ sÃ¡ch theo thá»© tá»± â†’ 15 cuá»‘n sau miá»…n phÃ­ ship! (**Cache Hit**)
> - Náº¿u báº¡n Ä‘á»c ngáº«u nhiÃªn sÃ¡ch tá»« kháº¯p nÆ¡i â†’ má»—i cuá»‘n = 1 thÃ¹ng hÃ ng má»›i â†’ phÃ­ ship cá»±c Ä‘áº¯t! (**Cache Miss**)

### 5.3. VÃ­ dá»¥ thá»±c táº¿: Cache Hit vs Miss

#### > Under the Hood: Táº¡i sao Random cháº­m?
HÃ£y nhÃ¬n vÃ o Assembly cá»§a vÃ²ng láº·p:

```asm
; VÃ²ng láº·p tÃ­nh tá»•ng (Simplified x86)
Loop_Start:
    MOV  RBX, [IndexArr + RCX*4]   ; 1. Táº£i index ngáº«u nhiÃªn tá»« máº£ng IndexArr
                                   ;    (Náº¿u láº·p tuáº§n tá»±, Index cÃ³ sáºµn trong L1)

    MOV  EAX, [DataArr + RBX*4]    ; 2. DÃ¹ng index Ä‘Ã³ Ä‘á»ƒ táº£i Data
                                   ;    âš ï¸ CACHE MISS Lá»šN á» ÄÃ‚Y!
                                   ;    VÃ¬ RBX nháº£y lung tung, CPU khÃ´ng Ä‘oÃ¡n Ä‘Æ°á»£c.
                                   ;    CPU pháº£i Dá»ªNG (Stall) ~300 cycles Ä‘á»ƒ Ä‘á»£i RAM.

    ADD  SUM, EAX                  ; 3. Cá»™ng (chá»‰ máº¥t 1 cycle)
    INC  RCX                       ; 4. TÄƒng Ä‘áº¿m
    CMP  RCX, 1000000
    JNE  Loop_Start
```
*   **Sequential:** DÃ²ng 2 luÃ´n trÃºng Cache (Hit) vÃ¬ CPU tá»± Ä‘á»™ng prefetch dÃ²ng tiáº¿p theo.
*   **Random:** DÃ²ng 2 trÆ°á»£t Cache (Miss) liÃªn tá»¥c. Lá»‡nh `ADD` á»Ÿ dÃ²ng 3 khÃ´ng thá»ƒ cháº¡y cho Ä‘áº¿n khi dÃ²ng 2 xong. CPU ngá»“i chÆ¡i 99% thá»i gian!

```
BÃ i toÃ¡n: TÃ­nh tá»•ng 1 triá»‡u sá»‘ (1,000,000 ints = ~4 MB)

â•â•â• Ká»‹ch báº£n 1: Duyá»‡t tuáº§n tá»± (Sequential) â•â•â•

  for (int i = 0; i < 1000000; i++)
      sum += data[i];    // Cache Hit 15/16 láº§n = 93.75%

  PhÃ¢n tÃ­ch:
  - Táº£i cache line chá»©a data[0..15] â†’ ~100 cycles   (Miss)
  - Äá»c data[0]: 0 cycles  (Hit)
  - Äá»c data[1]: 0 cycles  (Hit)
  - ...
  - Äá»c data[15]: 0 cycles (Hit)
  - Táº£i cache line chá»©a data[16..31] â†’ ~100 cycles  (Miss)
  - ... láº·p láº¡i

  Tá»•ng thá»i gian: ~62,500 cache misses Ã— 100 cycles = ~6.25M cycles
  Tá»‘c Ä‘á»™ thá»±c táº¿: â˜…â˜…â˜…â˜…â˜… Cá»°C NHANH


â•â•â• Ká»‹ch báº£n 2: Duyá»‡t ngáº«u nhiÃªn (Random) â•â•â•

  for (int i = 0; i < 1000000; i++)
      sum += data[random_index[i]];    // Cache Miss ~100%

  PhÃ¢n tÃ­ch:
  - Má»—i random_index chá»‰ Ä‘áº¿n vá»‹ trÃ­ khÃ¡c nhau trong 4MB
  - 4MB >> L1 Cache (64KB) â†’ gáº§n nhÆ° má»i truy cáº­p Ä‘á»u Miss
  - 1,000,000 misses Ã— 100 cycles = ~100M cycles

  Tá»‘c Ä‘á»™ thá»±c táº¿: â˜…â˜†â˜†â˜†â˜† CHáº¬M Gáº¤P 16 Láº¦N!
```

### 5.4. Báº£ng tá»‘c Ä‘á»™ chi tiáº¿t â€” Memory Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             KIM Tá»° THÃP Bá»˜ NHá»š â€” Memory Hierarchy                         â”‚
â”‚                                                                             â”‚
â”‚                          â–² NHANH                                            â”‚
â”‚                         â•± â•²                                                 â”‚
â”‚                        â•± R â•²       Registers                               â”‚
â”‚                       â•± 0ns â•²      ~1 KB | trÃªn CPU | 0 cycles            â”‚
â”‚                      â•±â”€â”€â”€â”€â”€â”€â”€â•²                                              â”‚
â”‚                     â•±  L1     â•²     L1 Cache                               â”‚
â”‚                    â•±  ~1ns     â•²    32-64 KB/core | trÃªn CPU | 3-4 cycles  â”‚
â”‚                   â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                                           â”‚
â”‚                  â•±    L2         â•²   L2 Cache                              â”‚
â”‚                 â•±    ~3ns         â•²  256KB-1MB/core | ~10-12 cycles        â”‚
â”‚                â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                                        â”‚
â”‚               â•±      L3            â•²  L3 Cache                             â”‚
â”‚              â•±      ~10ns           â•² 8-96 MB shared | ~30-40 cycles       â”‚
â”‚             â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                                     â”‚
â”‚            â•±         RAM (DDR5)        â•²  Main Memory                      â”‚
â”‚           â•±         ~50-100ns           â•² 16-128 GB | ~200 cycles          â”‚
â”‚          â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                                  â”‚
â”‚         â•±           SSD (NVMe)           â•²  Storage                        â”‚
â”‚        â•±           ~10,000ns              â•² 512GB-4TB | ~50,000 cycles     â”‚
â”‚       â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                                â”‚
â”‚      â•±             HDD                     â•² Archival                      â”‚
â”‚     â•±             ~5,000,000ns              â•² 1-16 TB | ~25,000,000 cycles â”‚
â”‚    â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                             â”‚
â”‚                     â–¼ CHáº¬M (nhÆ°ng Lá»šN)                                     â”‚
â”‚                                                                             â”‚
â”‚  Má»—i táº§ng cháº­m hÆ¡n táº§ng trÃªn khoáº£ng 3-10Ã—                                 â”‚
â”‚  Má»—i táº§ng lá»›n hÆ¡n táº§ng trÃªn khoáº£ng 10-1000Ã—                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Cache Associativity â€” Dá»¯ liá»‡u náº±m á»Ÿ Ä‘Ã¢u trong Cache?

### 6.1. Ba cÃ¡ch tá»• chá»©c Cache

```
â•â•â• Direct Mapped (Ãnh xáº¡ trá»±c tiáº¿p) â•â•â•
  Má»—i Ä‘á»‹a chá»‰ RAM chá»‰ cÃ³ THá»‚ náº±m á»Ÿ 1 vá»‹ trÃ­ cá»‘ Ä‘á»‹nh trong Cache.

  RAM Block 0, 4, 8, 12 â†’ Cache Line 0
  RAM Block 1, 5, 9, 13 â†’ Cache Line 1
  RAM Block 2, 6, 10,14 â†’ Cache Line 2
  RAM Block 3, 7, 11,15 â†’ Cache Line 3

  âœ… ÄÆ¡n giáº£n, nhanh
  âŒ Conflict Miss: Block 0 vÃ  Block 4 TRANH CHáº¤P cÃ¹ng cache line
     â†’ Náº¿u dÃ¹ng xen káº½ cáº£ hai â†’ liÃªn tá»¥c Ä‘uá»•i nhau ra!


â•â•â• Fully Associative (LiÃªn káº¿t hoÃ n toÃ n) â•â•â•
  Má»—i block RAM cÃ³ thá»ƒ náº±m á»Ÿ Báº¤T Ká»² cache line nÃ o.

  âœ… KhÃ´ng bao giá» cÃ³ conflict miss
  âŒ Pháº£i so sÃ¡nh Táº¤T Cáº¢ tags â†’ máº¡ch phá»©c táº¡p, cháº­m, tá»‘n Ä‘iá»‡n
  â†’ Chá»‰ dÃ¹ng cho cache ráº¥t nhá» (TLB)


â•â•â• Set-Associative (N-way) â€” Phá»• biáº¿n nháº¥t â•â•â•
  Cache chia thÃ nh Sets. Má»—i block RAM thuá»™c 1 Set cá»‘ Ä‘á»‹nh,
  nhÆ°ng trong Set Ä‘Ã³ cÃ³ N vá»‹ trÃ­ (Ways) Ä‘á»ƒ chá»n.

  VÃ­ dá»¥ 4-way Set-Associative:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚         â”‚ Way 0  â”‚ Way 1  â”‚ Way 2  â”‚ Way 3  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Set 0   â”‚ Blk 0  â”‚ Blk 4  â”‚ Blk 8  â”‚ (trá»‘ng)â”‚
  â”‚ Set 1   â”‚ Blk 1  â”‚ Blk 9  â”‚(trá»‘ng) â”‚(trá»‘ng) â”‚
  â”‚ Set 2   â”‚ Blk 2  â”‚(trá»‘ng) â”‚(trá»‘ng) â”‚(trá»‘ng) â”‚
  â”‚ Set 3   â”‚ Blk 3  â”‚ Blk 7  â”‚ Blk 11 â”‚ Blk 15 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  âœ… CÃ¢n báº±ng giá»¯a tá»‘c Ä‘á»™ vÃ  hiá»‡u quáº£
  âœ… Giáº£m conflict miss Ä‘Ã¡ng ká»ƒ
  â†’ L1 Cache thÆ°á»ng lÃ  8-way, L2 lÃ  8-16 way
```

> **ğŸ¯ áº¨n dá»¥ â€” Tá»§ khÃ³a KÃ½ tÃºc xÃ¡:**
> - **Direct Mapped** = Má»—i sinh viÃªn Ä‘Æ°á»£c gÃ¡n **Ä‘Ãºng 1 tá»§ cá»‘ Ä‘á»‹nh** (theo sá»‘ MSSV). Náº¿u 2 SV cÃ¹ng hash vá» 1 tá»§ â†’ tranh nhau, pháº£i luÃ¢n phiÃªn bá» Ä‘á»“ ra.
> - **Fully Associative** = Sinh viÃªn Ä‘Æ°á»£c chá»n **Báº¤T Ká»² tá»§ nÃ o trá»‘ng**. Tuyá»‡t vá»i! NhÆ°ng má»—i láº§n tÃ¬m Ä‘á»“ pháº£i má»Ÿ **Táº¤T Cáº¢** tá»§ Ä‘á»ƒ check â†’ cháº­m.
> - **Set-Associative (4-way)** = Má»—i SV Ä‘Æ°á»£c gÃ¡n **1 dÃ£y (set) gá»“m 4 tá»§**. Chá»n tá»§ nÃ o trá»‘ng trong dÃ£y Ä‘Ã³. TÃ¬m Ä‘á»“ chá»‰ cáº§n check 4 tá»§ thay vÃ¬ hÃ ng trÄƒm â†’ cÃ¢n báº±ng hoÃ n háº£o!

---

## 7. Cache Coherency â€” Váº¥n Ä‘á» Ä‘a lÃµi

### 7.1. False Sharing â€” "Káº» thÃ¹ giáº¥u máº·t" cá»§a Ä‘a luá»“ng

```
Ká»‹ch báº£n:
  2 lÃµi CPU cÃ¹ng truy cáº­p máº£ng counters[], nhÆ°ng TRÃŠ2 pháº§n tá»­ khÃ¡c nhau.

  struct Counters {
      public int countA;  // Core 0 dÃ¹ng
      public int countB;  // Core 1 dÃ¹ng
  }
  // sizeof(Counters) = 8 bytes
  // Cáº£ countA vÃ  countB náº±m trÃªn CÃ™NG 1 cache line (64 bytes)!


  Core 0                           Core 1
  â”€â”€â”€â”€â”€â”€                           â”€â”€â”€â”€â”€â”€
  countA++                         countB++
     â”‚                                â”‚
     â–¼                                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Cache Line (64 bytes):                         â”‚
  â”‚  [countA=1] [countB=0] [padding...............]  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                â”‚
     â”‚  "TÃ´i sá»­a cache line nÃ y!"    â”‚  "TÃ´i CÅ¨NG sá»­a cache line nÃ y!"
     â”‚                                â”‚
     â–¼                                â–¼
  MESI Protocol báº¯t buá»™c:
  1. Core 0 ghi countA â†’ Ä‘Ã¡nh dáº¥u cache line = "Modified"
  2. Core 1 muá»‘n ghi countB â†’ pháº£i INVALIDATE cache line á»Ÿ Core 0
  3. Core 0 flush cache line vá» L3 â†’ Core 1 táº£i láº¡i tá»« L3
  4. Core 1 ghi countB â†’ Ä‘Ã¡nh dáº¥u "Modified"
  5. Core 0 muá»‘n ghi countA láº§n ná»¯a â†’ láº¡i pháº£i invalidate...
  
  â†’ PING-PONG liÃªn tá»¥c! Má»—i láº§n = ~40-100 cycles wasted
  â†’ Hiá»‡u nÄƒng GIáº¢M tá»›i 10-100Ã— so vá»›i dÃ¹ng 1 lÃµi!
```

> **ğŸ¯ áº¨n dá»¥ â€” 2 ngÆ°á»i viáº¿t cÃ¹ng 1 trang vá»Ÿ:**
> TÆ°á»Ÿng tÆ°á»£ng 2 ngÆ°á»i ngá»“i 2 bÃ n, má»—i ngÆ°á»i viáº¿t **á»Ÿ GÃ“C RIÃŠNG** cá»§a cÃ¹ng 1 trang giáº¥y.
> - NgÆ°á»i A viáº¿t gÃ³c trÃ¡i â†’ xong, Ä‘Æ°a trang giáº¥y cho NgÆ°á»i B.
> - NgÆ°á»i B viáº¿t gÃ³c pháº£i â†’ xong, Ä‘Æ°a láº¡i cho NgÆ°á»i A.
> - DÃ¹ há» **KHÃ”NG CHáº M vÃ o chá»¯ cá»§a nhau**, nhÆ°ng vÃ¬ cÃ¹ng 1 trang giáº¥y (= cÃ¹ng 1 Cache Line), há» pháº£i **chuyá»n qua chuyá»n láº¡i** liÃªn tá»¥c.
> - **Giáº£i phÃ¡p:** Cho má»—i ngÆ°á»i viáº¿t trÃªn **TRANG RIÃŠNG** (= padding Ä‘á»ƒ tÃ¡ch cache line) â†’ khÃ´ng cáº§n chá» nhau ná»¯a!

**Giáº£i phÃ¡p: Äá»‡m (Padding) Ä‘á»ƒ tÃ¡ch cache line**

```csharp
struct CountersPadded {
    public int countA;
    // 60 bytes padding â†’ Ä‘áº©y countB sang cache line khÃ¡c
    fixed byte _pad[60];
    public int countB;
}

// Hoáº·c trong Unity DOTS:
// [NativeDisableContainerSafetyRestriction]
// â†’ Äáº·t dá»¯ liá»‡u cá»§a má»—i Job trÃªn chunk riÃªng biá»‡t
```

### 7.2. MESI Protocol â€” Quy Æ°á»›c Ä‘á»“ng bá»™ Cache

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MESI = 4 tráº¡ng thÃ¡i cá»§a má»—i Cache Line                     â”‚
â”‚                                                              â”‚
â”‚  M (Modified):   Chá»‰ core nÃ y cÃ³ data Má»šI NHáº¤T              â”‚
â”‚                  RAM Ä‘Ã£ lá»—i thá»i (pháº£i ghi láº¡i khi evict)   â”‚
â”‚                                                              â”‚
â”‚  E (Exclusive):  Chá»‰ core nÃ y cÃ³, nhÆ°ng GIá»NG vá»›i RAM       â”‚
â”‚                  CÃ³ thá»ƒ chuyá»ƒn sang M mÃ  khÃ´ng bÃ¡o ai       â”‚
â”‚                                                              â”‚
â”‚  S (Shared):     NHIá»€U cores Ä‘á»u cÃ³ copy giá»‘ng nhau          â”‚
â”‚                  Muá»‘n ghi â†’ pháº£i invalidate cÃ¡c core khÃ¡c   â”‚
â”‚                                                              â”‚
â”‚  I (Invalid):    Cache line nÃ y KHÃ”NG Há»¢P Lá»†                â”‚
â”‚                  Pháº£i táº£i láº¡i tá»« L3/RAM náº¿u cáº§n             â”‚
â”‚                                                              â”‚
â”‚  Chuyá»ƒn tráº¡ng thÃ¡i:                                          â”‚
â”‚  I â”€â”€Readâ”€â”€â–º E â”€â”€Writeâ”€â”€â–º M                                  â”‚
â”‚  E â”€â”€Other core readsâ”€â”€â–º S                                   â”‚
â”‚  S â”€â”€Writeâ”€â”€â–º M (+ Invalidate others â†’ I)                    â”‚
â”‚  M â”€â”€Other core readsâ”€â”€â–º S (+ Flush to L3)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Káº¿t ná»‘i Unity â€” Cache Locality lÃ  táº¥t cáº£

### 8.1. MonoBehaviour vs ECS â€” CÃ¢u chuyá»‡n Cache Line

**â•â•â• Classic MonoBehaviour (OOP) â€” Cache NIGHTMARE â•â•â•**

```csharp
class Enemy : MonoBehaviour {
    Vector3 position;     // 12 bytes
    float health;          // 4 bytes
    string name;           // 8 bytes (reference)
    Rigidbody rb;          // 8 bytes (reference)
    Animator animator;     // 8 bytes (reference)
    // ... + MonoBehaviour overhead = ~100+ bytes
}
```

```
Bá»™ nhá»› Heap (rá»i ráº¡c, ngáº«u nhiÃªn):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚Enemy[0]â”‚  â”‚ String â”‚  â”‚Enemy[1]â”‚  â”‚ Sound  â”‚
  â”‚ @0x100 â”‚  â”‚ @0x280 â”‚  â”‚ @0x500 â”‚  â”‚ @0x390 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘           â†‘           â†‘           â†‘
  Cache Line A  Cache Line E  Cache Line I  Cache Line G

  Duyá»‡t Enemy[0] â†’ Cache Miss (táº£i Line A)
  Duyá»‡t Enemy[1] â†’ Cache Miss (táº£i Line I)  â† KHÃC cache line!
  Duyá»‡t Enemy[2] â†’ Cache Miss (á»Ÿ Ä‘Ã¢u Ä‘Ã³ khÃ¡c trÃªn Heap)

  â†’ Cá»© Má»–I enemy = 1 Cache Miss = 200 cycles wasted
  â†’ 10,000 enemies = 2,000,000 cycles wasted = ~0.4ms á»Ÿ 5GHz
     (ChÆ°a ká»ƒ pointer chasing: position â†’ rb â†’ collider â†’ ...)
```

#### > The Pointer Chasing Problem (Assembly):
Äá»ƒ láº¥y `enemy.transform.position`, CPU pháº£i "sÄƒn tÃ¬m Ä‘á»‹a chá»‰" (pointer chasing):

```asm
MOV  R1, [EnemyAddress]        ; Táº£i Ä‘á»‹a chá»‰ object Enemy
MOV  R2, [R1 + TransformOffset]; Táº£i Ä‘á»‹a chá»‰ Transform component (CACHE MISS?)
MOV  R3, [R2 + PositionOffset] ; Táº£i dá»¯ liá»‡u Position (CACHE MISS?)
```

- Tá»‡ háº¡i: Lá»‡nh 2 **PHá»¤ THUá»˜C** vÃ o R1 tá»« lá»‡nh 1. Lá»‡nh 3 **PHá»¤ THUá»˜C** vÃ o R2 tá»« lá»‡nh 2.
- CPU khÃ´ng thá»ƒ "cháº¡y trÆ°á»›c" (Instruction Level Parallelism).
- Náº¿u lá»‡nh 1 Miss Cache, lá»‡nh 2 vÃ  3 pháº£i Ä‘á»£i â†’ **Chuá»—i dÃ¢y chuyá»n tháº£m há»a.**

---

**â•â•â• Unity ECS (DOD) â€” Cache PARADISE â•â•â•**

```csharp
struct Position : IComponentData { public float3 Value; }  // 12 bytes
struct Health : IComponentData { public float Value; }       // 4 bytes
```

```
Archetype Chunk (16 KB, contiguous):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Position Data (liÃªn tá»¥c):                                    â”‚
  â”‚ [pos0][pos1][pos2][pos3][pos4][pos5]...[pos659]              â”‚
  â”‚  12B   12B   12B   12B   12B   12B      12B                 â”‚
  â”‚ â—„â”€â”€â”€â”€ Cache Line (64B) = 5 positions â”€â”€â”€â”€â–º                  â”‚
  â”‚                                                              â”‚
  â”‚ Health Data (liÃªn tá»¥c):                                      â”‚
  â”‚ [hp0][hp1][hp2][hp3][hp4][hp5]...[hp659]                    â”‚
  â”‚  4B   4B   4B   4B   4B   4B      4B                        â”‚
  â”‚ â—„â”€â”€â”€â”€ Cache Line (64B) = 16 healths â”€â”€â”€â”€â–º                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Duyá»‡t Position:
  - Táº£i cache line â†’ cÃ³ 5 positions miá»…n phÃ­!
  - Cache Hit 4/5 = 80%
  - 10,000 entities Ã· 5 per line = 2,000 misses
  - 2,000 Ã— 100 cycles = 200,000 cycles = ~0.04ms

  â†’ ECS nhanh hÆ¡n MonoBehaviour ~10Ã— chá»‰ nhá» Cache Locality!
```

### 8.2. Táº¡i sao NativeArray khÃ´ng cÃ³ GC?

**C# Managed Array** (`new int[]`):
- Cáº¥p phÃ¡t trÃªn **Managed Heap**
- GC pháº£i quÃ©t (scan) Ä‘á»ƒ biáº¿t array cÃ²n dÃ¹ng khÃ´ng
- GC cÃ³ thá»ƒ **DI CHUYá»‚N** array (compaction) â†’ Ä‘á»‹a chá»‰ thay Ä‘á»•i
- KhÃ´ng thá»ƒ dÃ¹ng trong Burst (Burst cáº§n Ä‘á»‹a chá»‰ cá»‘ Ä‘á»‹nh cho SIMD)

**NativeArray\<int\>:**
- Cáº¥p phÃ¡t trÃªn **Unmanaged Heap** (qua `Marshal.AllocHGlobal` hoáº·c `UnsafeUtility`)
- GC **KHÃ”NG BIáº¾T** nÃ³ tá»“n táº¡i â†’ Zero GC pressure
- Äá»‹a chá»‰ **Cá» Äá»ŠNH** â†’ Burst dÃ¹ng trá»±c tiáº¿p cho SIMD
- Developer **PHáº¢I tá»± Dispose()** â†’ náº¿u quÃªn = Memory Leak

```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Managed Heap (GC quáº£n lÃ½):                         â”‚
  â”‚  [string] [List<T>] [MonoBehaviour] [GameObject]    â”‚
  â”‚  â†‘ GC scan toÃ n bá»™ vÃ¹ng nÃ y Ä‘á»‹nh ká»³                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Unmanaged Heap (Dev tá»± quáº£n lÃ½):                   â”‚
  â”‚  [NativeArray] [NativeList] [NativeHashMap]         â”‚
  â”‚  â†‘ GC KHÃ”NG CHáº M vÃ o vÃ¹ng nÃ y                      â”‚
  â”‚  â†‘ Burst Compiler truy cáº­p TRá»°C TIáº¾P               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3. Allocator Types â€” Chá»n Ä‘Ãºng táº§ng bá»™ nhá»›

| Allocator | MÃ´ táº£ | Æ¯u/NhÆ°á»£c | DÃ¹ng cho |
|---|---|---|---|
| **`Allocator.Temp`** | Stack-like, xÃ³a cuá»‘i frame | âœ… Cá»±c nhanh (khÃ´ng lock) Â· âŒ Chá»‰ sá»‘ng 1 frame | Káº¿t quáº£ táº¡m trong `Update()` |
| **`Allocator.TempJob`** | Sá»‘ng qua nhiá»u frame, tá»± xÃ³a sau 4 frame | âœ… An toÃ n cho Jobs Â· âŒ KhÃ´ng quÃ¡ lÃ¢u dÃ i | `IJobParallelFor` data |
| **`Allocator.Persistent`** | Sá»‘ng Ä‘áº¿n khi báº¡n `Dispose()` | âœ… DÃ i háº¡n Â· âŒ Cháº­m hÆ¡n, PHáº¢I tá»± Dispose | Lookup tables, spatial hash |

---

## 9. Tá»•ng káº¿t Chapter 2

```
Chuá»—i tiáº¿n hÃ³a bá»™ nhá»›:

  2 NOR Gates (8 transistors) â†’ SR Latch (nhá»› 1 bit)
       â”‚
       â–¼
  D Flip-flop (nhá»› 1 bit theo nhá»‹p Clock)
       â”‚
       â–¼
  32 D-FF = 1 Register (nhá»› 1 sá»‘ 32-bit)
       â”‚
       â–¼
  SRAM (6T/bit) â†’ L1/L2/L3 Cache (nhanh, Ä‘áº¯t, nhá»)
       â”‚
       â–¼
  DRAM (1T+1C/bit) â†’ DDR5 RAM (cháº­m hÆ¡n, ráº», lá»›n)
       â”‚
       â–¼
  NAND Flash â†’ SSD (ráº¥t cháº­m, ráº¥t ráº», ráº¥t lá»›n)
```

> **BÃ i há»c quan trá»ng nháº¥t:**
> - KhÃ´ng pháº£i **thuáº­t toÃ¡n nÃ o nhanh hÆ¡n** mÃ  lÃ  **dá»¯ liá»‡u nÃ o gáº§n CPU hÆ¡n**.
> - `O(n)` tuáº§n tá»± trÃªn Cache nhanh hÆ¡n `O(log n)` nháº£y ngáº«u nhiÃªn trÃªn RAM.
> - Unity ECS nhanh khÃ´ng pháº£i vÃ¬ ECS "thÃ´ng minh hÆ¡n", mÃ  vÃ¬ nÃ³ **Ä‘áº·t dá»¯ liá»‡u Ä‘Ãºng chá»—** Ä‘á»ƒ CPU Cache hoáº¡t Ä‘á»™ng hiá»‡u quáº£ nháº¥t.

---

> **ChÆ°Æ¡ng tiáº¿p theo:** [Chapter 3 â€” CPU, ISA & Programming Languages]() â€” CÃ¡ch CPU thá»±c thi lá»‡nh, Pipeline, Branch Prediction, vÃ  con Ä‘Æ°á»ng tá»« C# â†’ IL â†’ Native Code.

---
*Chapter 2 â€” NghiÃªn cá»©u cho Unity High-Performance Agent*
